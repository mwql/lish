<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LensLife Photography Portfolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-90 flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-sky-400 mb-4"></div>
        <p class="text-white text-lg">Initializing Portfolio and Auth...</p>
    </div>

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">LensLife Photography</h1>
            <div class="flex items-center space-x-4">
                <button id="admin-mode-toggle" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-150 ease-in-out hidden" onclick="toggleAdminPanel()">
                    Admin Panel
                </button>
                <span id="user-info" class="text-sm text-slate-500 hidden"></span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h2 class="text-4xl font-bold text-slate-700 mb-8 border-b-2 border-indigo-200 pb-2">The Gallery</h2>

        <div id="photo-gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            <p id="no-photos-message" class="col-span-full text-center text-slate-500 text-xl hidden">No photos yet. Use the Admin Panel to add some!</p>
        </div>
    </main>

    <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-75 z-40 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-slate-800">Add New Photo</h3>
                <button onclick="toggleAdminPanel()" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form id="add-photo-form">
                <div class="mb-4">
                    <label for="photo-title" class="block text-sm font-medium text-slate-700 mb-1">Title</label>
                    <input type="text" id="photo-title" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="photo-url" class="block text-sm font-medium text-slate-700 mb-1">Photo URL</label>
                    <input type="url" id="photo-url" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., https://placehold.co/600x400">
                </div>
                <div class="mb-6">
                    <label for="photo-description" class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                    <textarea id="photo-description" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                
                <button type="submit" id="submit-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg shadow-md transition duration-150 ease-in-out">
                    Add Photo to Gallery
                </button>
                <p id="form-message" class="mt-4 text-center text-sm text-red-500 hidden"></p>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ⚠️ IMPORTANT: REPLACE THESE WITH YOUR ACTUAL FIREBASE CONFIGURATION ⚠️ ---
        const appId = 'your-unique-photographer-app-id'; // A unique string identifier for your app data
        const firebaseConfig = {
            apiKey: "AIzaSyC_PLACEHOLDER_KEY", // Your API Key
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcedeefghijklmn",
            measurementId: "G-XXXXXXXXXX"
        };
        // Use initialAuthToken if you are passing a server-generated custom token for a specific user
        const initialAuthToken = null; // Or 'your-custom-auth-token-string' 

        // -----------------------------------------------------------------------------------

        setLogLevel('Debug');

        // --- GLOBAL VARIABLES ---
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const adminToggle = document.getElementById('admin-mode-toggle');
        const adminPanel = document.getElementById('admin-panel');
        const photoGallery = document.getElementById('photo-gallery');
        const noPhotosMessage = document.getElementById('no-photos-message');
        const userInfoSpan = document.getElementById('user-info');
        const addPhotoForm = document.getElementById('add-photo-form');
        const formMessage = document.getElementById('form-message');
        const submitButton = document.getElementById('submit-button');

        // --- UTILITY FUNCTIONS ---

        /**
         * Hides the loading overlay once initialization is complete.
         */
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        /**
         * Toggles the visibility of the Admin Panel modal.
         */
        window.toggleAdminPanel = function() {
            if (!isAuthReady || !userId) {
                console.error("Authentication not ready or user not logged in. Cannot open admin panel.");
                return;
            }
            adminPanel.classList.toggle('hidden');
        }

        /**
         * Renders the list of photos to the gallery.
         * @param {Array<Object>} photos - Array of photo data objects.
         */
        function renderGallery(photos) {
            photoGallery.innerHTML = ''; // Clear existing photos
            if (photos.length === 0) {
                noPhotosMessage.classList.remove('hidden');
                return;
            }
            noPhotosMessage.classList.add('hidden');

            photos.forEach(photo => {
                const photoCard = document.createElement('div');
                photoCard.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden transform hover:scale-[1.02]';
                
                photoCard.innerHTML = `
                    <div class="h-64 bg-slate-200 overflow-hidden">
                        <img src="${photo.url}" 
                             alt="${photo.title}" 
                             class="w-full h-full object-cover" 
                             loading="lazy"
                             onerror="this.onerror=null; this.src='https://placehold.co/600x400/ef4444/ffffff?text=Image+Error'">
                    </div>
                    <div class="p-5">
                        <h3 class="text-xl font-semibold text-slate-800 truncate">${photo.title}</h3>
                        <p class="text-sm text-slate-600 mt-2 line-clamp-2">${photo.description}</p>
                    </div>
                `;
                photoGallery.appendChild(photoCard);
            });
        }


        // --- FIRESTORE FUNCTIONS ---

        /**
         * Sets up a real-time listener for photos in the gallery.
         */
        function setupPhotoListener() {
            if (!db || !userId) return;

            // Collection path for the photographer's private photos
            // Path: artifacts/{appId}/users/{userId}/photos
            const photosCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'photos');
            
            // Query for photos
            const q = query(photosCollectionRef);

            // Set up real-time listener
            onSnapshot(q, (snapshot) => {
                const photos = [];
                snapshot.forEach(doc => {
                    photos.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort photos by client-side timestamp (newest first)
                photos.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                renderGallery(photos);
            }, (error) => {
                console.error("Error fetching photos in real-time:", error);
                // Display error message if needed
            });
        }
        
        /**
         * Adds a new photo entry to Firestore.
         * @param {Event} e - Form submission event.
         */
        async function addPhoto(e) {
            e.preventDefault();
            
            if (!db || !userId) {
                formMessage.textContent = "Authentication Error. Please refresh.";
                formMessage.classList.remove('hidden');
                return;
            }

            // Lock the button and show loading state
            submitButton.disabled = true;
            submitButton.textContent = 'Adding...';
            submitButton.classList.add('opacity-60');
            formMessage.classList.add('hidden');


            const title = document.getElementById('photo-title').value.trim();
            const url = document.getElementById('photo-url').value.trim();
            const description = document.getElementById('photo-description').value.trim();

            if (!title || !url) {
                formMessage.textContent = "Title and Photo URL are required.";
                formMessage.classList.remove('hidden');
                submitButton.disabled = false;
                submitButton.textContent = 'Add Photo to Gallery';
                submitButton.classList.remove('opacity-60');
                return;
            }

            try {
                const photosCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'photos');
                
                await addDoc(photosCollectionRef, {
                    title: title,
                    url: url,
                    description: description,
                    // Using Date.now() for client-side sorting stability, as serverTimestamp() is for Server Time.
                    timestamp: Date.now() 
                });

                // Success
                document.getElementById('photo-title').value = '';
                document.getElementById('photo-url').value = '';
                document.getElementById('photo-description').value = '';
                formMessage.textContent = "Photo added successfully!";
                formMessage.classList.remove('text-red-500');
                formMessage.classList.add('text-green-600');
                formMessage.classList.remove('hidden');
                
                // Optional: Close the modal after a successful add
                setTimeout(() => {
                    toggleAdminPanel();
                    formMessage.classList.add('hidden');
                    formMessage.classList.remove('text-green-600');
                    formMessage.classList.add('text-red-500');
                }, 1500);

                
            } catch (error) {
                console.error("Error adding document: ", error);
                formMessage.textContent = "Failed to add photo. Check console for details.";
                formMessage.classList.remove('text-green-600');
                formMessage.classList.add('text-red-500');
                formMessage.classList.remove('hidden');
            } finally {
                // Unlock the button
                submitButton.disabled = false;
                submitButton.textContent = 'Add Photo to Gallery';
                submitButton.classList.remove('opacity-60');
            }
        }


        // --- INITIALIZATION ---
        
        /**
         * Initializes Firebase and handles authentication.
         */
        async function initializeFirebase() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is incomplete. Please update the placeholder values.");
                photoGallery.innerHTML = '<p class="text-center text-red-500 text-xl col-span-full">FATAL ERROR: Firebase configuration missing/incomplete. Check console.</p>';
                hideLoading();
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Check for custom token and sign in
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    // Fallback to anonymous sign-in for public view/simple owner access
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // Listen for authentication state changes (this runs after the initial sign-in)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        
                        // Show admin button and user ID
                        adminToggle.classList.remove('hidden');
                        userInfoSpan.textContent = `User ID: ${userId.substring(0, 8)}...`;
                        userInfoSpan.classList.remove('hidden');

                        // Start fetching and listening for data only when authenticated
                        setupPhotoListener();
                    } else {
                        // User is signed out
                        userId = null;
                        isAuthReady = true;
                        renderGallery([]); // Clear gallery if needed
                    }
                    hideLoading();
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                hideLoading();
                // Display error message on the screen for the user
                photoGallery.innerHTML = '<p class="text-center text-red-500 text-xl col-span-full">Error: Could not connect to the database. Check console for details.</p>';
            }
        }

        // Add event listener for form submission
        addPhotoForm.addEventListener('submit', addPhoto);

        // Start initialization when the window loads
        window.addEventListener('load', initializeFirebase);
        
    </script>
</body>
</html>
